resources:
  jobs:
    alphafold:
      name: alphafold
      description: >
        # Alphafold_v2.3.2 workflow
        inputs:
         - protein: protein sequence. For multimer separate chains with colon, e.g CAS:CAR.
         - run_name: a name for the run
      email_notifications:
        on_failure:
          - ${var.current_user}
        on_duration_warning_threshold_exceeded:
          - ${var.current_user}
        no_alert_for_skipped_runs: true
      notification_settings:
        no_alert_for_skipped_runs: true
        no_alert_for_canceled_runs: true
      timeout_seconds: 86400
      health:
        rules:
          - metric: RUN_DURATION_SECONDS
            op: GREATER_THAN
            value: 50400
      max_concurrent_runs: 5

      tasks:
        - task_key: featurize
          notebook_task:
            notebook_path: ../notebooks/run_alphafold_featurize
            source: WORKSPACE
          job_cluster_key: featurize_cluster
          timeout_seconds: 28800
          health:
            rules:
              - metric: RUN_DURATION_SECONDS
                op: GREATER_THAN
                value: 14400
          email_notifications:
            on_failure:
              - ${var.current_user}
            on_duration_warning_threshold_exceeded:
              - ${var.current_user}
          notification_settings:
            no_alert_for_skipped_runs: true
            no_alert_for_canceled_runs: true
            alert_on_last_attempt: true

        - task_key: fold
          depends_on:
            - task_key: featurize
          notebook_task:
            notebook_path: ../notebooks/run_alphafold_fold
            source: WORKSPACE
          job_cluster_key: fold_cluster
          timeout_seconds: 14400
          health:
            rules:
              - metric: RUN_DURATION_SECONDS
                op: GREATER_THAN
                value: 3600
          email_notifications:
            on_failure:
              - ${var.current_user}
            on_duration_warning_threshold_exceeded:
              - ${var.current_user}
          notification_settings:
            no_alert_for_skipped_runs: true
            no_alert_for_canceled_runs: true
            alert_on_last_attempt: true

      parameters:
        - name: catalog
          default: ${var.core_catalog_name}
        - name: schema
          default: ${var.core_schema_name}
        - name: model_volume
          default: ${resources.volumes.alphafold_volume.name}
        - name: user_email
          default: ${var.current_user}      
        - name: protein_sequence
          default: XXX
        - name: experiment_name
          default: none
        - name: run_name
          default: run


      job_clusters:
        - job_cluster_key: featurize_cluster
          new_cluster:
            cluster_name: ""
            spark_version: 15.4.x-scala2.12
            spark_conf:
              spark.master: local[*, 4]
              spark.databricks.cluster.profile: singleNode
            node_type_id: Standard_F8
            driver_node_type_id: Standard_F8
            custom_tags:
              ResourceClass: SingleNode
              work_type: protein_folding
            spark_env_vars:
              PYSPARK_PYTHON: /databricks/python3/bin/python3
            enable_elastic_disk: true
            data_security_mode: SINGLE_USER
            runtime_engine: STANDARD
            num_workers: 0

        - job_cluster_key: fold_cluster
          new_cluster:
            cluster_name: ""
            spark_version: 15.4.x-gpu-ml-scala2.12
            spark_conf:
              spark.master: local[*, 4]
              spark.databricks.cluster.profile: singleNode
            node_type_id: Standard_NC4as_T4_v3
            driver_node_type_id: Standard_NC4as_T4_v3
            custom_tags:
              ResourceClass: SingleNode
              work_type: protein_folding
            enable_elastic_disk: true
            data_security_mode: SINGLE_USER
            runtime_engine: STANDARD
            num_workers: 0
      
      tags: ${var.common_resource_tags}

      queue:
        enabled: true
      
