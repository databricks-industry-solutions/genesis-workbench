resources:
  jobs:
    bionemo_esm_finetune:
      name: bionemo_esm_finetune_job

      email_notifications:
        on_failure:
          - ${var.current_user}

      tasks:
        - task_key: bionemo_esm_finetune_task
          job_cluster_key: job_cluster
          notebook_task:
            notebook_path: ../../notebooks/bionemo_esm_finetune.py
          max_retries: 0 

      parameters:
        - name: catalog
          default: ${var.core_catalog_name}
        - name: schema
          default: ${var.core_schema_name}
        - name: esm_variant
          default: 650M
        - name: train_data_location
          default: /Volumes/srijit_nair/bionemo/esm2/ft_data/BLAT_ECOLX_Tenaillon2013_metadata_train.csv
        - name: validation_data_location
          default: /Volumes/srijit_nair/bionemo/esm2/ft_data/BLAT_ECOLX_Tenaillon2013_metadata_eval.csv
        - name: should_use_lora
          default: false
        - name: finetune_label
          default: esm_650m_ft_xyz
        - name: core_catalog
          default: genesis_workbench
        - name: core_schema
          default: dev_srijit_nair_dbx_genesis_workbench_core
        - name: model_volume
          default: ${resources.volumes.bionemo_dir.name}
        - name: task_type
          default: regression
        - name: mlp_ft_dropout
          default: 0.25
        - name: mlp_hidden_size
          default: 256
        - name: mlp_target_size
          default: 1
        - name: experiment_name
          default: sequence_level_regression
        - name: num_steps
          default: 50
        - name: lr
          default: 5e-3
        - name: lr_multiplier
          default: 1e2
        - name: scale_lr_layer
          default: regression_head
        - name: micro_batch_size
          default: 2
        - name: precision
          default: bf16-mixed
        - name: user_email
          default: a@b.com

      job_clusters:
        - job_cluster_key: job_cluster
          new_cluster:
            num_workers: 0
            node_type_id: ${var.a10_node_type}
            driver_node_type_id: ${var.a10_node_type}
            spark_version: 15.4.x-scala2.12
            enable_elastic_disk: true
            data_security_mode: SINGLE_USER
            single_user_name: ${workspace.current_user.userName}
            docker_image:
              url: ${var.bionemo_docker_image}  
              basic_auth:
                username: ${var.bionemo_docker_userid}
                password: ${var.bionemo_docker_token}
            spark_conf:
              spark.databricks.cluster.profile: singleNode
              spark.databricks.unityCatalog.volumes.enabled: true
              spark.master: local[*]
            custom_tags:
              ResourceClass: SingleNode

      tags: ${var.common_resource_tags}


