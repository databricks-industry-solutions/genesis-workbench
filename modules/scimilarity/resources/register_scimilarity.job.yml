resources:
  jobs:
    register_scimilarity:
      name: register_scimilarity

      email_notifications:
        on_failure:
          - ${var.current_user}

      tasks:
        #this task can use serverless (OR 14.3 LTS L runtime)
        - task_key: wget_SCimilarity_task # register_scimilarity_task
          ## use serverless when files already exist in the cache_dir
          job_cluster_key: job_cluster_wget # maybe faster than serverless?
          notebook_task:
            notebook_path: ../notebooks/01_wget_scimilarity.py

        - task_key: register_GeneOrder_task
          depends_on: 
            - task_key: wget_SCimilarity_task
          job_cluster_key: job_cluster_gene_order
          notebook_task:
            notebook_path: ../notebooks/02_register_GeneOrder.py ###
        
        - task_key: register_GetEmbedding_task
          depends_on: 
            - task_key: wget_SCimilarity_task
          job_cluster_key: job_cluster_get_embedding
          notebook_task:
            notebook_path: ../notebooks/03_register_GetEmbedding.py ###
        
        - task_key: register_SearchNearest_task
          depends_on: 
            - task_key: wget_SCimilarity_task
          job_cluster_key: job_cluster_search_nearest
          notebook_task:
            notebook_path: ../notebooks/04_register_SearchNearest.py ###

        #this task need serverless runtime with python 3.11
        - task_key: import_scimilarity_models_task
          depends_on: 
            - task_key: register_GeneOrder_task, register_GetEmbedding_task, register_SearchNearest_task
          notebook_task:
            notebook_path: ../notebooks/05_import_model_gwb.py

      environments: ## serverless
        - environment_key: default
          spec:
            client: '2'
            
      parameters:
        - name: catalog
          default: ${var.core_catalog_name}
        - name: schema
          default: ${var.core_schema_name}
        - name: model_name
          default: SCimilarity ###
        - name: cache_dir
          default: ${resources.volumes.scimilarity.name} ###
        - name: experiment_name
          default: ${var.module_registration_experiment_name} ### 
        - name: sql_warehouse_id
          default: ${var.sql_warehouse_id}
        - name: user_email
          default: ${var.current_user}

      job_clusters:
        - job_cluster_key: job_cluster_wget
          new_cluster:
            num_workers: 0
            ### NEED larger compute for SCimilarity
            node_type_id: 'Standard_NV36ads_A10_v5' 
            driver_node_type_id: 'Standard_NV36ads_A10_v5'  
            spark_version: '14.3.x-gpu-ml-scala2.12'
            # spark_version: '14.3.x-cpu-ml-scala2.12'
            enable_elastic_disk: true
            data_security_mode: SINGLE_USER
            single_user_name: ${workspace.current_user.userName}
            spark_conf:
              spark.databricks.cluster.profile: singleNode
              spark.master: local[*]
            custom_tags:
              ResourceClass: SingleNode

        - job_cluster_key: job_cluster_gene_order
          new_cluster:
            num_workers: 0
            ### NEED larger compute for SCimilarity
            node_type_id: 'Standard_NV36ads_A10_v5'  
            driver_node_type_id: 'Standard_NV36ads_A10_v5'  
            spark_version: '14.3.x-gpu-ml-scala2.12'
            # spark_version: '14.3.x-cpu-ml-scala2.12'
            enable_elastic_disk: true
            data_security_mode: SINGLE_USER
            single_user_name: ${workspace.current_user.userName}
            spark_conf:
              spark.databricks.cluster.profile: singleNode
              spark.master: local[*]
            custom_tags:
              ResourceClass: SingleNode
        
        - job_cluster_key: job_cluster_get_embedding
          new_cluster:
            num_workers: 0
            ### NEED larger compute for SCimilarity
            node_type_id: 'Standard_NV36ads_A10_v5'  
            driver_node_type_id: 'Standard_NV36ads_A10_v5' 
            spark_version: '14.3.x-gpu-ml-scala2.12'
            # spark_version: '14.3.x-cpu-ml-scala2.12'
            enable_elastic_disk: true
            data_security_mode: SINGLE_USER
            single_user_name: ${workspace.current_user.userName}
            spark_conf:
              spark.databricks.cluster.profile: singleNode
              spark.master: local[*]
            custom_tags:
              ResourceClass: SingleNode
        
        - job_cluster_key: job_cluster_search_nearest
          new_cluster:
            num_workers: 0
            ### NEED larger RAM compute for SCimilarity: search_nearest
            node_type_id: 'Standard_NV36ads_A10_v5' # GPU 
            driver_node_type_id: 'Standard_NV36ads_A10_v5' # GPU  
            spark_version: '14.3.x-gpu-ml-scala2.12'
            # spark_version: '14.3.x-cpu-ml-scala2.12'
            enable_elastic_disk: true
            data_security_mode: SINGLE_USER
            single_user_name: ${workspace.current_user.userName}
            spark_conf:
              spark.databricks.cluster.profile: singleNode
              spark.master: local[*]
            custom_tags:
              ResourceClass: SingleNode
        
        # - job_cluster_key: job_cluster_A10_v5
        #   new_cluster:
        #     num_workers: 0
        #     ### NEED larger compute for SCimilarity || maybe a larger RAM + cpu works too 
        #     node_type_id: 'Standard_NV36ads_A10_v5' # Standard_NC16as_T4_v3 #'Standard_NC4as_T4_v3'  
        #     driver_node_type_id: 'Standard_NV36ads_A10_v5' # Standard_NC16as_T4_v3 #'Standard_NC4as_T4_v3' 
        #     spark_version: '14.3.x-gpu-ml-scala2.12'
        #     enable_elastic_disk: true
        #     data_security_mode: SINGLE_USER
        #     single_user_name: ${workspace.current_user.userName}
        #     spark_conf:
        #       spark.databricks.cluster.profile: singleNode
        #       spark.master: local[*]
        #     custom_tags:
        #       ResourceClass: SingleNode



        ## critical for model training 
        ## singleNode GPU options: ## Standard_NV36ads_A10_v5 #440gigs #'Standard_NC16as_T4_v3' #110gigs #'Standard_NC4as_T4_v3'  
        ## 14.3.x-gpu-ml-scala2.12

        ## singleNode CPU options: # Standard_E48ads_v5 #384gigs # Standard_E32ads_v5 #256gigs 
        ## 14.3.x-cpu-ml-scala2.12